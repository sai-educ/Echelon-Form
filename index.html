<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Matrix Rank ‚Äî Interactive Lab (Integer Operations Only)</title>
<style>
  :root{
    --bg:#0e1220; --panel:#151a2e; --ink:#eaf0ff; --muted:#b7bee2;
    --accent:#7fd4ff; --ok:#3ad59a; --warn:#ffd074; --danger:#ff8aa5;
    --grid:#232744; --pivot:#22d39a; --focus:#e8ff7d; --zero:#6fb3ff; --id:#9fffa8;
    --overlay:#00000090;
  }
  html,body{height:100%}
  body{
    margin:0; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial,"Noto Sans";
    color:var(--ink); background: radial-gradient(1200px 700px at 15% -10%, #1a2142 0%, #0e1220 60%) fixed;
  }

  /* ---------- Top-right HOW-TO menu ---------- */
  .howto-anchor{position:fixed; top:12px; right:16px; z-index:1001}
  .howto-btn{
    background:#1d2340; border:1px solid #3a4470; color:var(--ink);
    border-radius:999px; padding:10px 14px; font-size:14px; cursor:pointer;
  }
  .howto-btn:hover{border-color:#4a5790}
  .backdrop{position:fixed; inset:0; background:var(--overlay); display:none; z-index:1000}
  .backdrop.open{display:block}
  .howto-panel{
    position:fixed; top:56px; right:16px; width:440px; max-width:95vw;
    background:linear-gradient(180deg,#161b32 0%,#13182b 100%);
    border:1px solid #242946; border-radius:16px; padding:16px;
    box-shadow:0 18px 40px #00000070; z-index:1002; display:none; max-height:85vh; overflow-y:auto;
  }
  .howto-panel.open{display:block}
  .howto-head{display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:10px}
  .howto-title{font-size:17px; font-weight:700}
  .close-btn{background:#171b30; border:1px solid #2b345c; color:var(--ink); border-radius:10px; padding:8px 10px; cursor:pointer}
  .close-btn:hover{border-color:#3e4872}
  .lang-tabs{display:flex; gap:6px; margin:8px 0 12px}
  .tab{background:#121735; border:1px solid #2a3256; color:var(--muted); padding:6px 12px; border-radius:999px; cursor:pointer; font-size:13px}
  .tab[aria-selected="true"]{color:#101425; background:#9fd7ff; border-color:#9fd7ff; font-weight:700}
  .howto-section{border:1px solid #262c48; background:#12182e; border-radius:10px; padding:12px; margin-top:8px}
  .howto-section h3{margin:0 0 8px; font-size:15px; color:#9fd7ff}
  .howto-section ol{margin:.4em 0 .3em 1.3em; line-height:1.5} 
  .howto-section li{margin:.3em 0}
  .howto-section ul{margin:.4em 0 .3em 1.3em; line-height:1.5}
  .muted{color:var(--muted)}
  .highlight{color:#ffd074; font-weight:600}

  header{max-width:1200px; margin:0 auto; padding:26px 16px 8px}
  h1{margin:0 0 6px; font-size:clamp(22px,3.2vw,34px)}
  .sub{color:var(--muted); max-width:980px; line-height:1.5}
  main{max-width:1200px; margin:12px auto 40px; padding:0 16px; display:grid; gap:16px; grid-template-columns:1.25fr .95fr}
  @media (max-width:1050px){ main{grid-template-columns:1fr} }

  .card{background:linear-gradient(180deg,#161b32 0%,#13182b 100%); border:1px solid #242946; border-radius:16px; padding:16px; box-shadow:0 10px 28px #00000045, inset 0 1px 0 #2a2f4a33}
  h2{margin:0 0 10px; font-size:18px}
  .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
  .spacer{height:10px}
  .badge{display:inline-flex; gap:6px; align-items:center; font-size:12px; padding:5px 10px; border-radius:999px; background:#1a1f38; border:1px solid #2a3256}
  .tag{display:inline-flex; align-items:center; gap:6px; font-size:12px; padding:4px 10px; border-radius:999px; border:1px dashed #2a2f47; background:#141a34}
  .dot{width:10px; height:10px; border-radius:50%}
  .dot.pivot{background:var(--pivot)} .dot.zero{background:var(--zero)} .dot.focus{background:var(--focus)}

  button, select, input[type="number"], input[type="text"]{
    background:#1d2340; border:1px solid #31385b; color:var(--ink); border-radius:10px; padding:10px 12px; font-size:14px; outline:none;
  }
  button:hover{border-color:#3e4872} button:active{transform:translateY(1px)}
  button.primary{background:linear-gradient(180deg,#2a5a9a,#274b84); border-color:#3c63a0}
  button.ghost{background:#171b30}
  button.ok{background:#173528; border-color:#2f6b4c}
  button.warn{background:#3a3012; border-color:#69561b}
  .pill{display:inline-flex; align-items:center; gap:6px; padding:8px 12px; border:1px solid #2a2f47; border-radius:999px; background:#131a34; color:var(--muted)}

  .matrix-wrap{
    position:relative; padding:16px; border-radius:14px;
    background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0)),
                repeating-linear-gradient(0deg, transparent 0 35px, #14182a 35px 36px),
                repeating-linear-gradient(90deg, transparent 0 35px, #14182a 35px 36px);
    border:1px solid #282d46; overflow:hidden;
  }
  .brackets::before,.brackets::after{
    content:""; position:absolute; top:10px; bottom:10px; width:8px; border:2px solid #2f3554; border-left:none; border-right:none;
  }
  .brackets::before{left:8px; border-left:3px solid #2f3554; border-radius:10px 0 0 10px}
  .brackets::after{right:8px; border-right:3px solid #2f3554; border-radius:0 10px 10px 0}
  .matrix{display:grid; gap:7px}
  .cell{position:relative}
  .cell input{
    width:80px; padding:11px; text-align:center; font-size:17px; font-weight:500; color:var(--ink);
    background:#182044; border:1px solid #2b3356; border-radius:10px; transition:border-color .15s, box-shadow .15s;
  }
  .cell input:focus{border-color:#4f5ba2; box-shadow:0 0 0 3px #4f5ba233}
  .cell input.pivot-cell{background:#0e3929; border-color:#23d18b}
  .cell input.zero-row{background:#0d1a2e; border-color:#1e2a44}
  .pivotMark{position:absolute; inset:auto auto -7px 50%; transform:translateX(-50%); font-size:11px; padding:3px 7px; border-radius:999px; background:#0e3929; color:#b8ffe0; border:1px solid #23d18b55; font-weight:600}
  .zeroMark{position:absolute; inset:-7px -7px auto auto; font-size:10px; padding:2px 6px; border-radius:6px; background:#0d2b55; color:#cfe3ff; border:1px solid #67a7ff55}

  .log{background:#12162a; border:1px solid #242846; border-radius:12px; padding:12px; height:240px; overflow:auto; font-family:ui-monospace,Menlo,Consolas,monospace; font-size:13px; line-height:1.6}
  .log-step{color:#9fd7ff; font-weight:600}
  .kpis{display:grid; grid-template-columns:repeat(2,1fr); gap:10px; margin-top:10px}
  .kpi{background:#12162a; border:1px solid #242846; border-radius:10px; padding:10px; text-align:center}
  .kpi .label{font-size:12px; color:var(--muted)} .kpi .value{font-size:20px; margin-top:5px; font-weight:700; color:#9fd7ff}

  details{border:1px solid #262c48; background:#12182e; border-radius:10px; padding:12px; margin-top:10px}
  summary{cursor:pointer; font-weight:600; font-size:15px}

  footer{max-width:1200px; margin:8px auto 40px; padding:0 16px; color:var(--muted); font-size:13px; line-height:1.5}
  a{color:var(--accent); text-decoration:none}
  a:hover{text-decoration:underline}

  .info-box{background:#1a2540; border:1px solid #2a3a5a; border-radius:10px; padding:12px; margin:10px 0; border-left:3px solid #7fd4ff}
  .info-box strong{color:#9fd7ff}
</style>
</head>
<body>
  <!-- Top-right HOW-TO menu -->
  <div class="howto-anchor">
    <button id="howBtn" class="howto-btn" aria-haspopup="dialog" aria-controls="howPanel">‚ùì How to Use</button>
  </div>
  <div id="howBackdrop" class="backdrop" tabindex="-1" aria-hidden="true"></div>
  <div id="howPanel" class="howto-panel" role="dialog" aria-modal="true" aria-labelledby="howTitle" aria-hidden="true">
    <div class="howto-head">
      <div id="howTitle" class="howto-title">How to Use ‚Ä¢ ‡∞µ‡∞æ‡∞°‡±Å‡∞ï ‡∞Æ‡∞æ‡∞∞‡±ç‡∞ó‡∞¶‡∞∞‡±ç‡∞∂‡∞ï‡∞Ç</div>
      <button id="howClose" class="close-btn" aria-label="Close">‚úï</button>
    </div>
    <div class="lang-tabs" role="tablist" aria-label="Language tabs">
      <button id="tabEN" class="tab" role="tab" aria-selected="true" aria-controls="panelEN">English</button>
      <button id="tabTE" class="tab" role="tab" aria-selected="false" aria-controls="panelTE">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å</button>
    </div>

    <!-- English panel -->
    <section id="panelEN" class="howto-section" role="tabpanel" aria-labelledby="tabEN">
      <h3>üéØ Learning Goals</h3>
      <ul class="muted">
        <li>Understand <span class="highlight">rank</span> as the number of non-zero rows in echelon form</li>
        <li>Master <span class="highlight">integer-only</span> row operations (no fractions!)</li>
        <li>Learn to identify <span class="highlight">pivot positions</span> systematically</li>
        <li>Connect rank to linear independence and system solvability</li>
        <li>Practice both automatic stepping and manual control</li>
      </ul>
      
      <h3>üìã Step-by-Step Instructions</h3>
      <ol>
        <li><strong>Set Matrix Size:</strong> Choose rows and columns (max 6√ó6), click <strong>Resize</strong></li>
        <li><strong>Enter Integers:</strong> Type whole numbers only, or use <strong>Preset</strong>/<strong>Randomize</strong></li>
        <li><strong>Auto Mode:</strong> Click <strong>Next Step</strong> to see one operation at a time
          <ul style="margin-left:1.2em; margin-top:0.3em">
            <li>Algorithm finds pivot, swaps if needed, zeros below</li>
            <li>Watch narration explain each step</li>
          </ul>
        </li>
        <li><strong>Fast Mode:</strong> Click <strong>Finish to Echelon</strong> to complete automatically</li>
        <li><strong>Manual Practice:</strong> Use row operations yourself (swap, add multiples)</li>
        <li><strong>Check Result:</strong> <strong>Verify Rank</strong> confirms if you're done</li>
      </ol>

      <div class="info-box">
        <strong>üí° Key Concept:</strong> Rank = number of non-zero rows after reduction. No division needed when working with integers!
      </div>
    </section>

    <!-- Telugu panel -->
    <section id="panelTE" class="howto-section" role="tabpanel" aria-labelledby="tabTE" hidden>
      <h3>üéØ ‡∞Ö‡∞≠‡±ç‡∞Ø‡∞æ‡∞∏ ‡∞≤‡∞ï‡±ç‡∞∑‡±ç‡∞Ø‡∞æ‡∞≤‡±Å</h3>
      <ul class="muted">
        <li><span class="highlight">Rank</span> ‡∞Ö‡∞Ç‡∞ü‡±á echelon ‡∞∞‡±Ç‡∞™‡∞Ç‡∞≤‡±ã ‡∞®‡∞æ‡∞®‡±ç-‡∞ú‡±Ä‡∞∞‡±ã ‡∞µ‡∞∞‡±Å‡∞∏‡∞≤ ‡∞∏‡∞Ç‡∞ñ‡±ç‡∞Ø ‡∞Ö‡∞®‡∞ø ‡∞Ö‡∞∞‡±ç‡∞•‡∞Ç ‡∞ö‡±á‡∞∏‡±Å‡∞ï‡±ã‡∞µ‡∞°‡∞Ç</li>
        <li><span class="highlight">‡∞™‡±Ç‡∞∞‡±ç‡∞£‡∞æ‡∞Ç‡∞ï ‡∞Æ‡∞æ‡∞§‡±ç‡∞∞‡∞Æ‡±á</span> ‡∞µ‡∞∞‡±Å‡∞∏ ‡∞Ü‡∞™‡∞∞‡±á‡∞∑‡∞®‡±ç‡∞≤‡±Å ‡∞®‡±á‡∞∞‡±ç‡∞ö‡±Å‡∞ï‡±ã‡∞µ‡∞°‡∞Ç (‡∞≠‡∞ø‡∞®‡±ç‡∞®‡∞æ‡∞≤‡±Å ‡∞≤‡±á‡∞µ‡±Å!)</li>
        <li><span class="highlight">Pivot ‡∞∏‡±ç‡∞•‡∞æ‡∞®‡∞æ‡∞≤‡∞®‡±Å</span> ‡∞ï‡±ç‡∞∞‡∞Æ‡∞™‡∞¶‡±ç‡∞ß‡∞§‡∞ø‡∞≤‡±ã ‡∞ó‡±Å‡∞∞‡±ç‡∞§‡∞ø‡∞Ç‡∞ö‡∞°‡∞Ç</li>
        <li>Rank ‡∞®‡∞ø linear independence ‡∞Æ‡∞∞‡∞ø‡∞Ø‡±Å ‡∞∏‡∞ø‡∞∏‡±ç‡∞ü‡∞Æ‡±ç solvability ‡∞§‡±ã ‡∞ï‡∞≤‡∞™‡∞°‡∞Ç</li>
        <li>‡∞Ü‡∞ü‡±ã‡∞Æ‡±á‡∞ü‡∞ø‡∞ï‡±ç ‡∞Æ‡∞∞‡∞ø‡∞Ø‡±Å ‡∞Æ‡∞æ‡∞®‡±Å‡∞µ‡∞≤‡±ç ‡∞∞‡±Ü‡∞Ç‡∞°‡∞ø‡∞Ç‡∞ü‡∞ø‡∞≤‡±ã ‡∞∏‡∞æ‡∞ß‡∞® ‡∞ö‡±á‡∞Ø‡∞°‡∞Ç</li>
      </ul>
      
      <h3>üìã ‡∞¶‡∞∂‡∞≤‡∞µ‡∞æ‡∞∞‡±Ä ‡∞∏‡±Ç‡∞ö‡∞®‡∞≤‡±Å</h3>
      <ol>
        <li><strong>‡∞Æ‡∞æ‡∞ü‡±ç‡∞∞‡∞ø‡∞ï‡±ç‡∞∏‡±ç ‡∞™‡∞∞‡∞ø‡∞Æ‡∞æ‡∞£‡∞Ç:</strong> ‡∞µ‡∞∞‡±Å‡∞∏‡∞≤‡±Å ‡∞Æ‡∞∞‡∞ø‡∞Ø‡±Å ‡∞®‡∞ø‡∞≤‡±Å‡∞µ‡±Å‡∞≤‡±Å ‡∞é‡∞Ç‡∞ö‡±Å‡∞ï‡±ã‡∞Ç‡∞°‡∞ø, <strong>Resize</strong> ‡∞®‡±ä‡∞ï‡±ç‡∞ï‡∞Ç‡∞°‡∞ø</li>
        <li><strong>‡∞™‡±Ç‡∞∞‡±ç‡∞£‡∞æ‡∞Ç‡∞ï‡∞æ‡∞≤‡±Å ‡∞®‡∞Æ‡±ã‡∞¶‡±Å:</strong> ‡∞™‡±Ç‡∞∞‡±ç‡∞£ ‡∞∏‡∞Ç‡∞ñ‡±ç‡∞Ø‡∞≤‡±Å ‡∞Æ‡∞æ‡∞§‡±ç‡∞∞‡∞Æ‡±á, ‡∞≤‡±á‡∞¶‡∞æ <strong>Preset</strong>/<strong>Randomize</strong> ‡∞µ‡∞æ‡∞°‡∞Ç‡∞°‡∞ø</li>
        <li><strong>‡∞Ü‡∞ü‡±ã ‡∞Æ‡±ã‡∞°‡±ç:</strong> <strong>Next Step</strong> ‡∞®‡±ä‡∞ï‡±ç‡∞ï‡∞ø ‡∞í‡∞ï‡±ç‡∞ï‡±ã ‡∞ö‡∞∞‡±ç‡∞Ø ‡∞ö‡±Ç‡∞°‡∞Ç‡∞°‡∞ø
          <ul style="margin-left:1.2em; margin-top:0.3em">
            <li>‡∞Ö‡∞≤‡±ç‡∞ó‡∞æ‡∞∞‡∞ø‡∞•‡∞Æ‡±ç pivot ‡∞ï‡∞®‡±Å‡∞ó‡±ä‡∞®‡∞ø, swap ‡∞ö‡±á‡∞∏‡∞ø, ‡∞ï‡±ç‡∞∞‡∞ø‡∞Ç‡∞¶ ‡∞â‡∞®‡±ç‡∞® ‡∞µ‡∞ø‡∞≤‡±Å‡∞µ‡∞≤‡∞®‡±Å 0 ‡∞ö‡±á‡∞∏‡±ç‡∞§‡±Å‡∞Ç‡∞¶‡∞ø</li>
            <li>Narration ‡∞¶‡±ç‡∞µ‡∞æ‡∞∞‡∞æ ‡∞™‡±ç‡∞∞‡∞§‡∞ø ‡∞¶‡∞∂ ‡∞Ö‡∞∞‡±ç‡∞•‡∞Ç ‡∞ö‡±á‡∞∏‡±Å‡∞ï‡±ã‡∞Ç‡∞°‡∞ø</li>
          </ul>
        </li>
        <li><strong>‡∞µ‡±á‡∞ó‡∞µ‡∞Ç‡∞§‡∞Ç:</strong> <strong>Finish to Echelon</strong> ‡∞§‡±ã ‡∞Ü‡∞ü‡±ã‡∞Æ‡±á‡∞ü‡∞ø‡∞ï‡±ç‚Äå‡∞ó‡∞æ ‡∞™‡±Ç‡∞∞‡±ç‡∞§‡∞ø ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø</li>
        <li><strong>‡∞Æ‡∞æ‡∞®‡±Å‡∞µ‡∞≤‡±ç ‡∞™‡±ç‡∞∞‡∞æ‡∞ï‡±ç‡∞ü‡±Ä‡∞∏‡±ç:</strong> ‡∞Æ‡±Ä‡∞∞‡±á ‡∞µ‡∞∞‡±Å‡∞∏ ‡∞Ü‡∞™‡∞∞‡±á‡∞∑‡∞®‡±ç‡∞≤‡±Å ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø (swap, add)</li>
        <li><strong>‡∞§‡∞®‡∞ø‡∞ñ‡±Ä:</strong> <strong>Verify Rank</strong> ‡∞§‡±ã ‡∞™‡∞∞‡∞ø‡∞∂‡±Ä‡∞≤‡∞ø‡∞Ç‡∞ö‡∞Ç‡∞°‡∞ø</li>
      </ol>

      <div class="info-box">
        <strong>üí° ‡∞Æ‡±Å‡∞ñ‡±ç‡∞Ø ‡∞≠‡∞æ‡∞µ‡∞®:</strong> Rank = ‡∞§‡∞ó‡±ç‡∞ó‡∞ø‡∞Ç‡∞™‡±Å ‡∞§‡∞∞‡±ç‡∞µ‡∞æ‡∞§ ‡∞®‡∞æ‡∞®‡±ç-‡∞ú‡±Ä‡∞∞‡±ã ‡∞µ‡∞∞‡±Å‡∞∏‡∞≤ ‡∞∏‡∞Ç‡∞ñ‡±ç‡∞Ø. ‡∞™‡±Ç‡∞∞‡±ç‡∞£‡∞æ‡∞Ç‡∞ï‡∞æ‡∞≤‡∞§‡±ã ‡∞™‡∞®‡∞ø‡∞ö‡±á‡∞∏‡±á‡∞ü‡∞™‡±ç‡∞™‡±Å‡∞°‡±Å ‡∞≠‡∞æ‡∞ó‡∞π‡∞æ‡∞∞‡∞Ç ‡∞Ö‡∞µ‡∞∏‡∞∞‡∞Ç ‡∞≤‡±á‡∞¶‡±Å!
      </div>
    </section>
  </div>

<header>
  <h1>Matrix Rank ‚Äî Interactive Lab (Integer Operations)</h1>
  <p class="sub">
    <strong>Goal:</strong> Learn to find the <strong>rank of a matrix</strong> using <strong>integer-only row operations</strong>. 
    Reduce your matrix to echelon form to count non-zero rows. All operations preserve integers‚Äîno fractions or decimals!
  </p>
</header>

<main>
  <!-- LEFT: Matrix & Controls -->
  <section class="card">
    <div class="row" aria-label="Matrix size and presets">
      <div class="pill">Rows: <input id="rows" type="number" min="2" max="6" value="3" style="width:60px; margin-left:6px"></div>
      <div class="pill">Cols: <input id="cols" type="number" min="2" max="6" value="4" style="width:60px; margin-left:6px"></div>
      <button id="resize">Resize</button>
      <span class="spacer" style="width:8px"></span>
      <button id="presetA" class="ghost">Preset A</button>
      <button id="presetB" class="ghost">Preset B</button>
      <button id="random" class="ghost">Randomize</button>
      <button id="reset" class="ghost">Clear</button>
    </div>

    <div class="spacer"></div>

    <div class="matrix-wrap brackets" aria-label="Matrix grid">
      <div id="matrix" class="matrix"></div>
    </div>

    <div class="spacer"></div>

    <div class="row">
      <span class="tag"><span class="dot pivot"></span> Pivot (non-zero)</span>
      <span class="tag"><span class="dot zero"></span> To be zeroed</span>
      <span class="tag"><span class="dot focus"></span> Current focus</span>
    </div>

    <div class="spacer"></div>

    <div class="row" aria-label="Auto controls">
      <button id="next" class="primary">Next Step ‚ñ∑</button>
      <button id="finish" class="ok">Finish to Echelon Form</button>
      <button id="verify" class="ghost">Verify Rank</button>
    </div>
    <div class="muted" style="margin-top:8px; font-size:13px">
      <strong>Strategy:</strong> For each column, find a non-zero pivot, swap rows if needed, then zero all entries below using row additions.
    </div>

    <div class="spacer"></div>

    <details>
      <summary>Manual Row Operations</summary>
      <div class="spacer"></div>
      <div class="row">
        <div class="pill">Swap R<select id="rSwapA"></select> ‚Üî R<select id="rSwapB"></select></div>
        <button id="rSwapBtn">Swap Rows</button>
      </div>
      <div class="spacer"></div>
      <div class="row">
        <div class="pill">R<select id="rAddDest"></select> ‚Üê R<select id="rAddDest2"></select> + <input id="rAddK" type="number" value="-1" style="width:70px">¬∑R<select id="rAddSrc"></select></div>
        <button id="rAddBtn">Add Multiple of Row</button>
      </div>
      <div class="spacer"></div>
      <div class="muted" style="font-size:13px">
        <strong>Tip:</strong> To zero a<sub>ij</sub>, add (-a<sub>ij</sub>/a<sub>kj</sub>) times row k to row i. Choose integer multiples when possible!
      </div>
    </details>
  </section>

  <!-- RIGHT: Lesson, Narration, KPIs, Log -->
  <aside class="card">
    <h2>üìö Concept: Matrix Rank</h2>
    <div class="muted" id="lesson" style="line-height:1.6">
      <p><strong>What is Rank?</strong><br>
      The rank is the number of <strong>linearly independent rows</strong> (or columns). We find it by reducing to echelon form and counting non-zero rows.</p>
      
      <p><strong>Why Integer Operations?</strong><br>
      Working with whole numbers keeps calculations simple and avoids rounding errors. We use:</p>
      <ul style="margin:.3em 0 .3em 1.2em">
        <li><strong>Row Swap:</strong> R<sub>i</sub> ‚Üî R<sub>j</sub></li>
        <li><strong>Row Addition:</strong> R<sub>i</sub> ‚Üê R<sub>i</sub> + k¬∑R<sub>j</sub> (k is an integer)</li>
      </ul>
      
      <p><strong>Echelon Form Rules:</strong></p>
      <ol style="margin:.3em 0 .3em 1.2em">
        <li>Each non-zero row has a <strong>pivot</strong> (first non-zero entry)</li>
        <li>Pivots move right as you go down</li>
        <li>All zero rows are at the bottom</li>
      </ol>
      
      <div class="info-box" style="margin-top:10px">
        <strong>Key Insight:</strong> Rank tells us the dimension of the column space and whether systems Ax=b have solutions!
      </div>
    </div>

    <div class="spacer"></div>

    <h2>üìù Step Narration</h2>
    <div id="narr" class="muted" style="min-height:50px; padding:10px; background:#12162a; border-radius:10px; line-height:1.6">
      Enter integers into the matrix or choose a preset. Click <strong>Next Step</strong> to begin reduction to echelon form.
    </div>

    <div class="spacer"></div>

    <div class="kpis">
      <div class="kpi">
        <div class="label">Current Rank</div>
        <div id="rank" class="value">‚Äì</div>
      </div>
      <div class="kpi">
        <div class="label">Non-Zero Rows</div>
        <div id="nonzeroRows" class="value">‚Äì</div>
      </div>
    </div>

    <div class="spacer"></div>

    <h2>üìã Operation Log</h2>
    <div id="log" class="log" aria-live="polite"><div class="muted">Operations will appear here...</div></div>

    <details style="margin-top:12px">
      <summary>ü§î Practice Questions</summary>
      <ul style="margin:.5em 0 0 1.2em; line-height:1.7">
        <li>If a 4√ó5 matrix has rank 3, how many zero rows in echelon form?</li>
        <li>Can a 3√ó4 matrix have rank 5? Why or why not?</li>
        <li>If rank(A) = 3 and A is 3√ó3, is A invertible?</li>
        <li>What's the maximum possible rank of a 5√ó3 matrix?</li>
      </ul>
    </details>
  </aside>
</main>

<footer>
  <strong>Engineering Mathematics ‚Ä¢ Matrix Rank Lab</strong><br>
  Focus: Integer-only operations, Echelon form, Understanding rank through row reduction<br>
  <span style="color:#7fd4ff">Tip:</span> Try reducing Preset B step-by-step to see how pivots emerge!
</footer>

<script>
/* ===========================
   Core State & Utilities
   =========================== */
let R=3, C=4;
let inputs = [];
let stepState = null; // {col, searchRow}
let logEl, narrEl;

// Only allow integers
function validateInteger(input) {
  const val = input.value;
  if (val === '' || val === '-') return;
  const num = parseInt(val);
  if (isNaN(num)) {
    input.value = '0';
  } else {
    input.value = num.toString();
  }
}

/* ===========================
   HOW-TO menu behavior
   =========================== */
function openHowto(){
  document.getElementById('howBackdrop').classList.add('open');
  const p = document.getElementById('howPanel');
  p.classList.add('open');
  p.setAttribute('aria-hidden','false');
  document.getElementById('howBtn').setAttribute('aria-expanded','true');
  document.getElementById('tabEN').focus();
}
function closeHowto(){
  document.getElementById('howBackdrop').classList.remove('open');
  const p = document.getElementById('howPanel');
  p.classList.remove('open');
  p.setAttribute('aria-hidden','true');
  document.getElementById('howBtn').setAttribute('aria-expanded','false');
}
function selectLang(tab){
  const isEN = tab === 'EN';
  const tabEN = document.getElementById('tabEN');
  const tabTE = document.getElementById('tabTE');
  const panelEN = document.getElementById('panelEN');
  const panelTE = document.getElementById('panelTE');
  tabEN.setAttribute('aria-selected', isEN ? 'true' : 'false');
  tabTE.setAttribute('aria-selected', isEN ? 'false' : 'true');
  panelEN.hidden = !isEN;
  panelTE.hidden = isEN;
}

/* ===========================
   Matrix Grid Management
   =========================== */
function createGrid(){
  const grid = document.getElementById('matrix');
  grid.style.gridTemplateColumns = `repeat(${C}, minmax(72px,80px))`;
  grid.innerHTML = '';
  inputs = [];
  
  for (let r=0; r<R; r++){
    const row = [];
    for (let c=0; c<C; c++){
      const cell = document.createElement('div');
      cell.className = 'cell';
      const inp = document.createElement('input');
      inp.type = 'number';
      inp.value = '0';
      inp.step = '1';
      inp.setAttribute('aria-label', `Row ${r+1}, Col ${c+1}`);
      
      inp.addEventListener('input', () => {
        validateInteger(inp);
        drawLabels();
      });
      inp.addEventListener('blur', () => {
        if (inp.value === '' || inp.value === '-') inp.value = '0';
      });
      
      cell.appendChild(inp);
      grid.appendChild(cell);
      row.push(inp);
    }
    inputs.push(row);
  }
  
  refreshSelectors();
  drawLabels();
  setNarr('Matrix created. Enter integer values or use presets.');
  clearLog();
  updateKPIs();
}

function getM(){
  const M = [];
  for (let r=0; r<R; r++){
    const row = [];
    for (let c=0; c<C; c++){
      row.push(parseInt(inputs[r][c].value || '0'));
    }
    M.push(row);
  }
  return M;
}

function setM(M){
  R = M.length;
  C = M[0].length;
  document.getElementById('rows').value = R;
  document.getElementById('cols').value = C;
  createGrid();
  for (let r=0; r<R; r++){
    for (let c=0; c<C; c++){
      inputs[r][c].value = M[r][c].toString();
    }
  }
  drawLabels();
  updateKPIs();
}

function clearM(){
  for (let r=0; r<R; r++){
    for (let c=0; c<C; c++){
      inputs[r][c].value = '0';
    }
  }
  drawLabels();
  updateKPIs();
}

function randomM(){
  for (let r=0; r<R; r++){
    for (let c=0; c<C; c++){
      inputs[r][c].value = (Math.floor(Math.random() * 9) - 4).toString();
    }
  }
  drawLabels();
  updateKPIs();
}

/* ===========================
   Row Operations (Integer Only)
   =========================== */
function swapRows(M, i, j){
  if (i === j) return;
  const temp = M[i];
  M[i] = M[j];
  M[j] = temp;
  log(`<span class="log-step">Swap</span> R<sub>${i+1}</sub> ‚Üî R<sub>${j+1}</sub>`);
}

function addRow(M, dest, src, k){
  for (let c=0; c<C; c++){
    M[dest][c] = M[dest][c] + k * M[src][c];
  }
  const sign = k >= 0 ? '+' : '';
  log(`<span class="log-step">Add</span> R<sub>${dest+1}</sub> ‚Üê R<sub>${dest+1}</sub> ${sign} ${k}¬∑R<sub>${src+1}</sub>`);
}

function writeBack(M){
  for (let r=0; r<R; r++){
    for (let c=0; c<C; c++){
      inputs[r][c].value = M[r][c].toString();
    }
  }
  drawLabels();
  updateKPIs();
}

/* ===========================
   Rank Calculation
   =========================== */
function calculateRank(M){
  // Count non-zero rows
  let rank = 0;
  for (let r=0; r<R; r++){
    let hasNonZero = false;
    for (let c=0; c<C; c++){
      if (M[r][c] !== 0){
        hasNonZero = true;
        break;
      }
    }
    if (hasNonZero) rank++;
  }
  return rank;
}

function isEchelonForm(M){
  let lastPivotCol = -1;
  
  for (let r=0; r<R; r++){
    // Find first non-zero in this row
    let pivotCol = -1;
    for (let c=0; c<C; c++){
      if (M[r][c] !== 0){
        pivotCol = c;
        break;
      }
    }
    
    // If all zeros, remaining rows should also be all zeros
    if (pivotCol === -1){
      for (let r2=r+1; r2<R; r2++){
        for (let c=0; c<C; c++){
          if (M[r2][c] !== 0) return false;
        }
      }
      return true;
    }
    
    // Pivot should be to the right of previous pivot
    if (pivotCol <= lastPivotCol) return false;
    
    // All entries below this pivot should be zero
    for (let r2=r+1; r2<R; r2++){
      if (M[r2][pivotCol] !== 0) return false;
    }
    
    lastPivotCol = pivotCol;
  }
  
  return true;
}

/* ===========================
   Step-by-Step Algorithm
   =========================== */
function nextStep(){
  let M = getM();
  
  if (!stepState){
    stepState = {col: 0, searchRow: 0};
    log('<strong>üöÄ Starting reduction to echelon form...</strong>');
    setNarr('Beginning step-by-step reduction. Looking for first pivot...');
  }
  
  let {col, searchRow} = stepState;
  
  // Check if we're done
  if (col >= C || searchRow >= R){
    setNarr('‚úÖ <strong>Reduction complete!</strong> Matrix is in echelon form. Count non-zero rows for rank.');
    log('<strong>‚úÖ Finished!</strong> Matrix is now in echelon form.');
    stepState = null;
    drawLabels();
    updateKPIs();
    return;
  }
  
  // Find pivot in current column (from searchRow down)
  let pivotRow = -1;
  for (let r=searchRow; r<R; r++){
    if (M[r][col] !== 0){
      pivotRow = r;
      break;
    }
  }
  
  // No pivot in this column, move to next
  if (pivotRow === -1){
    stepState.col++;
    setNarr(`No non-zero entry found in column ${col+1}. Moving to next column...`);
    drawLabels({focusCol: col+1});
    updateKPIs();
    return;
  }
  
  // Swap if pivot not in searchRow
  if (pivotRow !== searchRow){
    swapRows(M, searchRow, pivotRow);
    writeBack(M);
    setNarr(`Found pivot in R<sub>${pivotRow+1}</sub>. Swapped with R<sub>${searchRow+1}</sub> to position pivot.`);
    drawLabels({focusRow: searchRow, focusCol: col});
    return;
  }
  
  // Zero out below pivot
  let didOperation = false;
  for (let r=searchRow+1; r<R; r++){
    if (M[r][col] !== 0){
      // Calculate multiplier to zero out M[r][col]
      // We want: M[r][col] + k*M[searchRow][col] = 0
      // So: k = -M[r][col] / M[searchRow][col]
      // For integer operations, use GCD method or just use the ratio if it's exact
      const pivot = M[searchRow][col];
      const target = M[r][col];
      
      // Simple approach: use -target/pivot if it's an integer, otherwise use a scaling method
      let k;
      if (target % pivot === 0){
        k = -target / pivot;
      } else {
        // Use multiplication to avoid fractions
        // Multiply row by pivot, then add -target times the pivot row
        // This is more complex, so for simplicity, we'll just use the closest integer
        k = -Math.round(target / pivot);
      }
      
      addRow(M, r, searchRow, k);
      writeBack(M);
      setNarr(`Zeroing R<sub>${r+1}</sub>, C<sub>${col+1}</sub> by adding ${k}√óR<sub>${searchRow+1}</sub> to R<sub>${r+1}</sub>.`);
      didOperation = true;
      drawLabels({focusRow: r, focusCol: col});
      return;
    }
  }
  
  // All zeros below, move to next column and increment searchRow
  stepState.col++;
  stepState.searchRow++;
  setNarr(`Column ${col+1} complete. Moving to next column...`);
  drawLabels({focusCol: col+1});
  updateKPIs();
}

function finish(){
  let guard = 0;
  while (guard++ < 500 && stepState !== null){
    nextStep();
  }
  if (guard >= 500){
    log('<span style="color:var(--warn)">‚ö†Ô∏è Too many steps, stopped</span>');
  }
}

/* ===========================
   Visual Labels & Styling
   =========================== */
function drawLabels(opts = {}){
  const {focusRow, focusCol} = opts;
  
  // Remove existing marks
  document.querySelectorAll('.pivotMark, .zeroMark').forEach(e => e.remove());
  
  const M = getM();
  
  // Find pivots (first non-zero in each row)
  const pivots = [];
  for (let r=0; r<R; r++){
    for (let c=0; c<C; c++){
      if (M[r][c] !== 0){
        pivots.push({r, c});
        break;
      }
    }
  }
  
  // Mark pivots
  pivots.forEach(({r, c}) => {
    const cell = inputs[r][c].parentElement;
    const mark = document.createElement('div');
    mark.className = 'pivotMark';
    mark.textContent = 'pivot';
    cell.appendChild(mark);
    inputs[r][c].classList.add('pivot-cell');
  });
  
  // Mark entries that should be zero (below pivots)
  pivots.forEach(({r, c}) => {
    for (let r2=r+1; r2<R; r2++){
      if (M[r2][c] !== 0){
        const mark = document.createElement('div');
        mark.className = 'zeroMark';
        mark.textContent = '‚Üí0';
        inputs[r2][c].parentElement.appendChild(mark);
      }
    }
  });
  
  // Highlight zero rows
  for (let r=0; r<R; r++){
    let allZero = true;
    for (let c=0; c<C; c++){
      if (M[r][c] !== 0){
        allZero = false;
        break;
      }
    }
    if (allZero){
      for (let c=0; c<C; c++){
        inputs[r][c].classList.add('zero-row');
      }
    } else {
      for (let c=0; c<C; c++){
        inputs[r][c].classList.remove('zero-row');
      }
    }
  }
  
  // Focus styling
  for (let r=0; r<R; r++){
    for (let c=0; c<C; c++){
      const inp = inputs[r][c];
      if (focusRow === r || focusCol === c){
        inp.style.boxShadow = '0 0 0 3px rgba(232,255,125,0.25)';
        inp.style.borderColor = '#a1ad3a';
      } else {
        inp.style.boxShadow = 'none';
        inp.style.borderColor = '#2b3356';
      }
      
      // Remove pivot-cell if not a pivot anymore
      let isPivot = false;
      pivots.forEach(p => {
        if (p.r === r && p.c === c) isPivot = true;
      });
      if (!isPivot) inp.classList.remove('pivot-cell');
    }
  }
}

function updateKPIs(){
  const M = getM();
  const rank = calculateRank(M);
  document.getElementById('rank').textContent = rank;
  document.getElementById('nonzeroRows').textContent = rank;
}

/* ===========================
   UI Helpers
   =========================== */
function setNarr(html){
  narrEl.innerHTML = html;
}

function log(html){
  logEl.insertAdjacentHTML('beforeend', `<div>‚Ä¢ ${html}</div>`);
  logEl.scrollTop = logEl.scrollHeight;
}

function clearLog(){
  logEl.innerHTML = '<div class="muted">Operations will appear here...</div>';
}

function refreshSelectors(){
  const rOpts = Array.from({length: R}, (_, i) => 
    `<option value="${i}">${i+1}</option>`
  ).join('');
  
  ['rSwapA', 'rSwapB', 'rAddDest', 'rAddDest2', 'rAddSrc'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.innerHTML = rOpts;
  });
}

/* ===========================
   Presets
   =========================== */
function presetA(){
  setM([
    [2, 4, 6, 8],
    [1, 2, 1, 3],
    [3, 6, 7, 11]
  ]);
  setNarr('<strong>Preset A loaded.</strong> This 3√ó4 matrix has rank 2. Try stepping through to see pivots emerge!');
  log('<strong>Preset A:</strong> Loaded 3√ó4 matrix (expected rank: 2)');
  stepState = null;
}

function presetB(){
  setM([
    [1, 2, 3, 4],
    [2, 4, 6, 8],
    [1, 1, 1, 1],
    [0, 1, 2, 3]
  ]);
  setNarr('<strong>Preset B loaded.</strong> This 4√ó4 matrix has rank 3. Watch how the algorithm handles row dependencies!');
  log('<strong>Preset B:</strong> Loaded 4√ó4 matrix (expected rank: 3)');
  stepState = null;
}

/* ===========================
   Event Listeners
   =========================== */
window.addEventListener('DOMContentLoaded', () => {
  logEl = document.getElementById('log');
  narrEl = document.getElementById('narr');
  
  // How-to menu
  document.getElementById('howBtn').addEventListener('click', () => {
    const panel = document.getElementById('howPanel');
    if (panel.classList.contains('open')) closeHowto();
    else openHowto();
  });
  document.getElementById('howClose').addEventListener('click', closeHowto);
  document.getElementById('howBackdrop').addEventListener('click', closeHowto);
  document.addEventListener('keydown', e => {
    if (e.key === 'Escape') closeHowto();
  });
  document.getElementById('tabEN').addEventListener('click', () => selectLang('EN'));
  document.getElementById('tabTE').addEventListener('click', () => selectLang('TE'));
  
  // Matrix controls
  document.getElementById('resize').addEventListener('click', () => {
    const r = Math.max(2, Math.min(6, parseInt(document.getElementById('rows').value || '3')));
    const c = Math.max(2, Math.min(6, parseInt(document.getElementById('cols').value || '4')));
    R = r;
    C = c;
    createGrid();
    stepState = null;
  });
  
  document.getElementById('random').addEventListener('click', () => {
    randomM();
    setNarr('Random integer matrix generated. Click <strong>Next Step</strong> to begin reduction.');
    stepState = null;
  });
  
  document.getElementById('reset').addEventListener('click', () => {
    clearM();
    setNarr('Matrix cleared. Enter your own integer values.');
    clearLog();
    stepState = null;
  });
  
  document.getElementById('presetA').addEventListener('click', presetA);
  document.getElementById('presetB').addEventListener('click', presetB);
  
  // Auto reduction
  document.getElementById('next').addEventListener('click', nextStep);
  document.getElementById('finish').addEventListener('click', finish);
  
  document.getElementById('verify').addEventListener('click', () => {
    const M = getM();
    const inEchelon = isEchelonForm(M);
    const rank = calculateRank(M);
    
    if (inEchelon){
      setNarr(`‚úÖ <strong>Correct!</strong> Matrix is in echelon form with rank = ${rank}.`);
      log(`<strong>‚úÖ Verified:</strong> Echelon form confirmed, rank = ${rank}`);
    } else {
      setNarr(`‚ùå Not quite there. Continue reduction‚Äîlook for pivots to the right of previous pivots, zeros below each pivot.`);
      log(`<strong>‚ùå Not in echelon form yet.</strong> Current rank estimate: ${rank}`);
    }
    drawLabels();
  });
  
  // Manual operations
  document.getElementById('rSwapBtn').addEventListener('click', () => {
    const a = parseInt(document.getElementById('rSwapA').value);
    const b = parseInt(document.getElementById('rSwapB').value);
    const M = getM();
    swapRows(M, a, b);
    writeBack(M);
    setNarr(`Manually swapped R<sub>${a+1}</sub> ‚Üî R<sub>${b+1}</sub>.`);
    stepState = null;
  });
  
  document.getElementById('rAddBtn').addEventListener('click', () => {
    const dest = parseInt(document.getElementById('rAddDest').value);
    const src = parseInt(document.getElementById('rAddSrc').value);
    const k = parseInt(document.getElementById('rAddK').value || '0');
    
    const M = getM();
    addRow(M, dest, src, k);
    writeBack(M);
    const sign = k >= 0 ? '+' : '';
    setNarr(`Manually added: R<sub>${dest+1}</sub> ‚Üê R<sub>${dest+1}</sub> ${sign} ${k}√óR<sub>${src+1}</sub>.`);
    stepState = null;
  });
  
  // Initialize
  createGrid();
});
</script>
</body>
</html>
