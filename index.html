<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Matrix Rank — Interactive Lab (Integer Operations)</title>
<style>
  :root{
    --bg:#0e1220; --panel:#151a2e; --ink:#eaf0ff; --muted:#b7bee2;
    --accent:#7fd4ff; --ok:#3ad59a; --warn:#ffd074; --danger:#ff8aa5;
    --grid:#232744; --pivot:#22d39a; --focus:#e8ff7d; --zero:#6fb3ff; --id:#9fffa8;
    --overlay:#00000090;
  }
  
  * { box-sizing: border-box; }
  
  html,body{height:100%; margin:0; padding:0; overflow-x:hidden;}
  body{
    font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial,"Noto Sans";
    color:var(--ink); 
    background: radial-gradient(1200px 700px at 15% -10%, #1a2142 0%, #0e1220 60%) fixed;
    -webkit-font-smoothing: antialiased;
    -webkit-tap-highlight-color: transparent;
  }

  /* ---------- Top-right HOW-TO menu ---------- */
  .howto-anchor{position:fixed; top:10px; right:10px; z-index:1001}
  .howto-btn{
    background:#1d2340; border:1px solid #3a4470; color:var(--ink);
    border-radius:999px; padding:10px 16px; font-size:14px; cursor:pointer;
    min-height:44px; display:flex; align-items:center; gap:6px;
    touch-action: manipulation;
  }
  .howto-btn:active{transform:scale(0.97)}
  .howto-btn:hover{border-color:#4a5790}
  .backdrop{position:fixed; inset:0; background:var(--overlay); display:none; z-index:1000}
  .backdrop.open{display:block}
  .howto-panel{
    position:fixed; top:0; right:0; bottom:0; width:min(440px, 100vw);
    background:linear-gradient(180deg,#161b32 0%,#13182b 100%);
    border-left:1px solid #242946; 
    box-shadow:0 0 40px #00000070; z-index:1002; display:none;
    overflow-y:auto; -webkit-overflow-scrolling: touch;
  }
  .howto-panel.open{display:block; animation:slideIn 0.3s ease}
  @keyframes slideIn{from{transform:translateX(100%)} to{transform:translateX(0)}}
  .howto-inner{padding:16px}
  .howto-head{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:12px; position:sticky; top:0; background:#161b32; padding:12px; margin:-16px -16px 12px; z-index:10; border-bottom:1px solid #242946}
  .howto-title{font-size:16px; font-weight:700}
  .close-btn{background:#171b30; border:1px solid #2b345c; color:var(--ink); border-radius:10px; padding:10px 12px; cursor:pointer; min-height:44px; min-width:44px; display:flex; align-items:center; justify-content:center; touch-action:manipulation}
  .close-btn:active{transform:scale(0.95)}
  .close-btn:hover{border-color:#3e4872}
  .lang-tabs{display:flex; gap:6px; margin:8px 0 14px}
  .tab{background:#121735; border:1px solid #2a3256; color:var(--muted); padding:10px 16px; border-radius:999px; cursor:pointer; font-size:14px; flex:1; text-align:center; min-height:44px; display:flex; align-items:center; justify-content:center; touch-action:manipulation}
  .tab:active{transform:scale(0.97)}
  .tab[aria-selected="true"]{color:#101425; background:#9fd7ff; border-color:#9fd7ff; font-weight:700}
  .howto-section{border:1px solid #262c48; background:#12182e; border-radius:10px; padding:14px; margin-top:10px}
  .howto-section h3{margin:0 0 10px; font-size:15px; color:#9fd7ff}
  .howto-section ol{margin:.5em 0 .4em 1.4em; line-height:1.7; padding-left:0} 
  .howto-section li{margin:.4em 0}
  .howto-section ul{margin:.5em 0 .4em 1.4em; line-height:1.7; padding-left:0}
  .muted{color:var(--muted)}
  .highlight{color:#ffd074; font-weight:600}

  header{max-width:1200px; margin:0 auto; padding:20px 16px 12px}
  h1{margin:0 0 8px; font-size:clamp(20px,5vw,34px); line-height:1.2}
  .sub{color:var(--muted); max-width:980px; line-height:1.6; font-size:clamp(13px,3.5vw,15px)}
  
  main{
    max-width:1200px; margin:12px auto 40px; padding:0 12px; 
    display:grid; gap:14px; grid-template-columns:1fr;
  }
  @media (min-width:768px){ 
    main{grid-template-columns:1.3fr 1fr; padding:0 16px; gap:16px} 
  }

  .card{
    background:linear-gradient(180deg,#161b32 0%,#13182b 100%); 
    border:1px solid #242946; border-radius:14px; padding:14px; 
    box-shadow:0 10px 28px #00000045, inset 0 1px 0 #2a2f4a33
  }
  h2{margin:0 0 12px; font-size:clamp(16px,4vw,18px)}
  .row{display:flex; gap:6px; flex-wrap:wrap; align-items:center}
  .spacer{height:10px}
  .tag{
    display:inline-flex; align-items:center; gap:6px; 
    font-size:11px; padding:6px 10px; border-radius:999px; 
    border:1px dashed #2a2f47; background:#141a34;
    white-space:nowrap;
  }
  .dot{width:10px; height:10px; border-radius:50%; flex-shrink:0}
  .dot.pivot{background:var(--pivot)} 
  .dot.zero{background:var(--zero)} 
  .dot.focus{background:var(--focus)}

  button, select, input[type="number"], input[type="text"]{
    background:#1d2340; border:1px solid #31385b; color:var(--ink); 
    border-radius:10px; padding:11px 14px; font-size:14px; outline:none;
    min-height:44px; touch-action:manipulation;
  }
  button{cursor:pointer; font-weight:500; display:inline-flex; align-items:center; justify-content:center; gap:6px}
  button:active{transform:scale(0.97)}
  button:hover{border-color:#3e4872}
  button.primary{background:linear-gradient(180deg,#2a5a9a,#274b84); border-color:#3c63a0; font-weight:600}
  button.ghost{background:#171b30}
  button.ok{background:#173528; border-color:#2f6b4c; font-weight:600}
  button.warn{background:#3a3012; border-color:#69561b}
  
  .pill{
    display:inline-flex; align-items:center; gap:6px; 
    padding:8px 12px; border:1px solid #2a2f47; 
    border-radius:999px; background:#131a34; color:var(--muted);
    font-size:13px; flex-wrap:wrap;
  }
  .pill input, .pill select{
    padding:8px 10px; min-height:38px; font-size:13px;
  }

  /* Matrix Container - Responsive */
  .matrix-wrap{
    position:relative; padding:12px; border-radius:12px;
    background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0)),
                repeating-linear-gradient(0deg, transparent 0 calc(var(--cell-size) + 8px), #14182a calc(var(--cell-size) + 8px) calc(var(--cell-size) + 9px)),
                repeating-linear-gradient(90deg, transparent 0 calc(var(--cell-size) + 8px), #14182a calc(var(--cell-size) + 8px) calc(var(--cell-size) + 9px));
    border:1px solid #282d46; overflow-x:auto; overflow-y:visible;
    -webkit-overflow-scrolling: touch;
    --cell-size: 70px;
  }
  @media (min-width:400px){
    .matrix-wrap{--cell-size: 80px; padding:14px}
  }
  @media (min-width:768px){
    .matrix-wrap{--cell-size: 90px; padding:16px}
  }
  
  .brackets::before,.brackets::after{
    content:""; position:absolute; top:8px; bottom:8px; width:6px; 
    border:2px solid #2f3554; border-left:none; border-right:none;
  }
  .brackets::before{left:6px; border-left:3px solid #2f3554; border-radius:8px 0 0 8px}
  .brackets::after{right:6px; border-right:3px solid #2f3554; border-radius:0 8px 8px 0}
  
  .matrix{
    display:grid; 
    gap:6px;
    grid-template-columns:repeat(var(--cols), var(--cell-size));
    min-width:min-content;
  }
  @media (min-width:400px){
    .matrix{gap:7px}
  }
  
  .cell{position:relative}
  .cell input{
    width:100%; height:var(--cell-size); 
    padding:8px; text-align:center; 
    font-size:clamp(16px, 4vw, 18px); 
    font-weight:600; color:var(--ink);
    background:#182044; border:2px solid #2b3356; 
    border-radius:10px; 
    transition:border-color .2s, box-shadow .2s;
    appearance:none;
    -webkit-appearance:none;
    -moz-appearance:textfield;
  }
  .cell input::-webkit-inner-spin-button,
  .cell input::-webkit-outer-spin-button{
    -webkit-appearance:none; margin:0;
  }
  .cell input:focus{
    border-color:#4f5ba2; 
    box-shadow:0 0 0 3px #4f5ba233;
    outline:none;
  }
  .cell input.pivot-cell{
    background:#0e3929; border-color:#23d18b; box-shadow:0 0 12px #23d18b33;
  }
  .cell input.zero-row{background:#0d1a2e; border-color:#1e2a44}
  
  .pivotMark{
    position:absolute; bottom:-8px; left:50%; transform:translateX(-50%); 
    font-size:10px; padding:3px 7px; border-radius:999px; 
    background:#0e3929; color:#b8ffe0; border:1px solid #23d18b55; 
    font-weight:600; white-space:nowrap; pointer-events:none;
  }
  .zeroMark{
    position:absolute; top:-8px; right:-8px; 
    font-size:9px; padding:2px 6px; border-radius:6px; 
    background:#0d2b55; color:#cfe3ff; border:1px solid #67a7ff55;
    pointer-events:none;
  }

  .log{
    background:#12162a; border:1px solid #242846; border-radius:12px; 
    padding:12px; height:200px; overflow:auto; 
    font-family:ui-monospace,Menlo,Consolas,monospace; 
    font-size:12px; line-height:1.7;
    -webkit-overflow-scrolling: touch;
  }
  @media (min-width:768px){
    .log{height:240px; font-size:13px}
  }
  .log-step{color:#9fd7ff; font-weight:600}
  
  .kpis{
    display:grid; grid-template-columns:repeat(2,1fr); 
    gap:8px; margin-top:10px;
  }
  .kpi{
    background:#12162a; border:1px solid #242846; 
    border-radius:10px; padding:12px; text-align:center;
  }
  .kpi .label{font-size:11px; color:var(--muted); margin-bottom:6px} 
  .kpi .value{font-size:clamp(18px,5vw,22px); font-weight:700; color:#9fd7ff}

  details{
    border:1px solid #262c48; background:#12182e; 
    border-radius:10px; padding:12px; margin-top:12px;
  }
  summary{
    cursor:pointer; font-weight:600; font-size:14px; 
    min-height:44px; display:flex; align-items:center;
    touch-action:manipulation; user-select:none;
  }
  details[open] summary{margin-bottom:12px}

  footer{
    max-width:1200px; margin:8px auto 40px; padding:0 16px; 
    color:var(--muted); font-size:12px; line-height:1.6;
  }
  a{color:var(--accent); text-decoration:none}
  a:hover{text-decoration:underline}

  .info-box{
    background:#1a2540; border:1px solid #2a3a5a; 
    border-radius:10px; padding:12px; margin:10px 0; 
    border-left:3px solid #7fd4ff; font-size:13px; line-height:1.6;
  }
  .info-box strong{color:#9fd7ff}

  /* Mobile-specific adjustments */
  @media (max-width:767px){
    .row{gap:6px}
    .pill{font-size:12px; padding:7px 10px}
    button{font-size:13px; padding:10px 12px}
    .tag{font-size:10px; padding:5px 8px}
    h2{margin-bottom:10px}
    .howto-section{padding:12px}
    .howto-section h3{font-size:14px}
    .howto-section li, .howto-section ul{font-size:13px; line-height:1.6}
    .info-box{font-size:12px}
  }

  /* Ensure buttons wrap nicely on mobile */
  @media (max-width:400px){
    .row.auto-controls{flex-direction:column; align-items:stretch}
    .row.auto-controls button{width:100%}
  }
</style>
</head>
<body>
  <!-- Top-right HOW-TO menu -->
  <div class="howto-anchor">
    <button id="howBtn" class="howto-btn" aria-haspopup="dialog" aria-controls="howPanel">
      <span>❓</span>
      <span>How to Use</span>
    </button>
  </div>
  <div id="howBackdrop" class="backdrop" tabindex="-1" aria-hidden="true"></div>
  <div id="howPanel" class="howto-panel" role="dialog" aria-modal="true" aria-labelledby="howTitle" aria-hidden="true">
    <div class="howto-inner">
      <div class="howto-head">
        <div id="howTitle" class="howto-title">How to Use • వాడుక మార్గదర్శకం</div>
        <button id="howClose" class="close-btn" aria-label="Close">✕</button>
      </div>
      <div class="lang-tabs" role="tablist" aria-label="Language tabs">
        <button id="tabEN" class="tab" role="tab" aria-selected="true" aria-controls="panelEN">English</button>
        <button id="tabTE" class="tab" role="tab" aria-selected="false" aria-controls="panelTE">తెలుగు</button>
      </div>

      <!-- English panel -->
      <section id="panelEN" class="howto-section" role="tabpanel" aria-labelledby="tabEN">
        <h3>🎯 Learning Goals</h3>
        <ul class="muted">
          <li>Understand <span class="highlight">rank</span> as the number of non-zero rows in echelon form</li>
          <li>Master <span class="highlight">integer-only</span> row operations (no fractions!)</li>
          <li>Learn to identify <span class="highlight">pivot positions</span> systematically</li>
          <li>Connect rank to linear independence and system solvability</li>
          <li>Practice both automatic stepping and manual control</li>
        </ul>
        
        <h3>📋 Step-by-Step Instructions</h3>
        <ol>
          <li><strong>Set Matrix Size:</strong> Choose rows and columns (max 6×6), tap <strong>Resize</strong></li>
          <li><strong>Enter Integers:</strong> Tap cells to enter whole numbers, or use <strong>Preset</strong>/<strong>Randomize</strong></li>
          <li><strong>Auto Mode:</strong> Tap <strong>Next Step</strong> to see one operation at a time. Watch narration explain each step.</li>
          <li><strong>Fast Mode:</strong> Tap <strong>Finish to Echelon</strong> to complete automatically</li>
          <li><strong>Manual Practice:</strong> Use row operations yourself (swap, add multiples)</li>
          <li><strong>Check Result:</strong> <strong>Verify Rank</strong> confirms if you're done</li>
        </ol>

        <div class="info-box">
          <strong>💡 Key Concept:</strong> Rank = number of non-zero rows after reduction. No division needed when working with integers!
        </div>
      </section>

      <!-- Telugu panel -->
      <section id="panelTE" class="howto-section" role="tabpanel" aria-labelledby="tabTE" hidden>
        <h3>🎯 అభ్యాస లక్ష్యాలు</h3>
        <ul class="muted">
          <li><span class="highlight">Rank</span> అంటే echelon రూపంలో నాన్-జీరో వరుసల సంఖ్య అని అర్థం చేసుకోవడం</li>
          <li><span class="highlight">పూర్ణాంక మాత్రమే</span> వరుస ఆపరేషన్లు నేర్చుకోవడం (భిన్నాలు లేవు!)</li>
          <li><span class="highlight">Pivot స్థానాలను</span> క్రమపద్ధతిలో గుర్తించడం</li>
          <li>Rank ని linear independence మరియు సిస్టమ్ solvability తో కలపడం</li>
          <li>ఆటోమేటిక్ మరియు మానువల్ రెండింటిలో సాధన చేయడం</li>
        </ul>
        
        <h3>📋 దశలవారీ సూచనలు</h3>
        <ol>
          <li><strong>మాట్రిక్స్ పరిమాణం:</strong> వరుసలు మరియు నిలువులు ఎంచుకోండి, <strong>Resize</strong> నొక్కండి</li>
          <li><strong>పూర్ణాంకాలు నమోదు:</strong> సెల్స్ పై నొక్కి పూర్ణ సంఖ్యలు ఇవ్వండి, లేదా <strong>Preset</strong>/<strong>Randomize</strong> వాడండి</li>
          <li><strong>ఆటో మోడ్:</strong> <strong>Next Step</strong> నొక్కి ఒక్కో చర్య చూడండి. Narration ద్వారా ప్రతి దశ అర్థం చేసుకోండి.</li>
          <li><strong>వేగవంతం:</strong> <strong>Finish to Echelon</strong> తో ఆటోమేటిక్‌గా పూర్తి చేయండి</li>
          <li><strong>మానువల్ ప్రాక్టీస్:</strong> మీరే వరుస ఆపరేషన్లు చేయండి (swap, add)</li>
          <li><strong>తనిఖీ:</strong> <strong>Verify Rank</strong> తో పరిశీలించండి</li>
        </ol>

        <div class="info-box">
          <strong>💡 ముఖ్య భావన:</strong> Rank = తగ్గింపు తర్వాత నాన్-జీరో వరుసల సంఖ్య. పూర్ణాంకాలతో పనిచేసేటప్పుడు భాగహారం అవసరం లేదు!
        </div>
      </section>
    </div>
  </div>

<header>
  <h1>Matrix Rank — Interactive Lab</h1>
  <p class="sub">
    <strong>Goal:</strong> Learn to find the <strong>rank of a matrix</strong> using <strong>integer-only row operations</strong>. 
    Reduce your matrix to echelon form to count non-zero rows. All operations preserve integers—no fractions!
  </p>
</header>

<main>
  <!-- Matrix & Controls -->
  <section class="card">
    <div class="row" aria-label="Matrix size and presets">
      <div class="pill">
        <span>Rows:</span>
        <input id="rows" type="number" inputmode="numeric" min="2" max="6" value="3" style="width:55px">
      </div>
      <div class="pill">
        <span>Cols:</span>
        <input id="cols" type="number" inputmode="numeric" min="2" max="6" value="4" style="width:55px">
      </div>
      <button id="resize">Resize</button>
    </div>

    <div class="spacer"></div>

    <div class="row">
      <button id="presetA" class="ghost">Preset A</button>
      <button id="presetB" class="ghost">Preset B</button>
      <button id="random" class="ghost">Random</button>
      <button id="reset" class="ghost">Clear</button>
    </div>

    <div class="spacer"></div>

    <div class="matrix-wrap brackets" aria-label="Matrix grid">
      <div id="matrix" class="matrix"></div>
    </div>

    <div class="spacer"></div>

    <div class="row" style="font-size:11px">
      <span class="tag"><span class="dot pivot"></span> Pivot</span>
      <span class="tag"><span class="dot zero"></span> To zero</span>
      <span class="tag"><span class="dot focus"></span> Focus</span>
    </div>

    <div class="spacer"></div>

    <div class="row auto-controls" aria-label="Auto controls">
      <button id="next" class="primary">Next Step ▷</button>
      <button id="finish" class="ok">Finish</button>
      <button id="verify" class="ghost">Verify</button>
    </div>
    <div class="muted" style="margin-top:10px; font-size:12px; line-height:1.5">
      <strong>Strategy:</strong> Find pivot → swap if needed → zero below it
    </div>

    <div class="spacer"></div>

    <details>
      <summary>Manual Row Operations</summary>
      <div class="spacer"></div>
      
      <div class="pill" style="width:100%; justify-content:space-between; margin-bottom:8px">
        <span style="font-size:12px">Swap R<select id="rSwapA"></select> ↔ R<select id="rSwapB"></select></span>
        <button id="rSwapBtn" style="padding:8px 12px; min-height:38px; font-size:12px">Swap</button>
      </div>
      
      <div class="spacer"></div>
      
      <div style="border:1px solid #2a2f47; border-radius:10px; padding:10px; background:#0d1220">
        <div style="font-size:12px; margin-bottom:8px; color:var(--muted)">
          R<select id="rAddDest" style="width:50px; padding:6px; font-size:12px"></select> ← 
          R<select id="rAddDest2" style="width:50px; padding:6px; font-size:12px"></select> + 
          <input id="rAddK" type="number" inputmode="numeric" value="-1" style="width:60px; padding:6px; font-size:12px">·R<select id="rAddSrc" style="width:50px; padding:6px; font-size:12px"></select>
        </div>
        <button id="rAddBtn" style="width:100%">Add Multiple of Row</button>
      </div>
      
      <div class="spacer"></div>
      <div class="muted" style="font-size:11px; line-height:1.5">
        <strong>Tip:</strong> To zero entry below pivot, calculate the right multiple and add.
      </div>
    </details>
  </section>

  <!-- Lesson, Narration, KPIs, Log -->
  <aside class="card">
    <h2>📚 Concept: Matrix Rank</h2>
    <div class="muted" id="lesson" style="line-height:1.6; font-size:13px">
      <p><strong>What is Rank?</strong><br>
      The rank is the number of <strong>linearly independent rows</strong>. We find it by reducing to echelon form and counting non-zero rows.</p>
      
      <p><strong>Integer Operations:</strong></p>
      <ul style="margin:.3em 0 .3em 1.2em">
        <li><strong>Swap:</strong> R<sub>i</sub> ↔ R<sub>j</sub></li>
        <li><strong>Add:</strong> R<sub>i</sub> ← R<sub>i</sub> + k·R<sub>j</sub></li>
      </ul>
      
      <div class="info-box" style="margin-top:12px">
        <strong>Key:</strong> Rank tells us the dimension of column space and system solvability!
      </div>
    </div>

    <div class="spacer"></div>

    <h2>📝 Step Narration</h2>
    <div id="narr" class="muted" style="min-height:60px; padding:12px; background:#12162a; border-radius:10px; line-height:1.6; font-size:13px">
      Enter integers or choose a preset. Tap <strong>Next Step</strong> to begin.
    </div>

    <div class="spacer"></div>

    <div class="kpis">
      <div class="kpi">
        <div class="label">Current Rank</div>
        <div id="rank" class="value">–</div>
      </div>
      <div class="kpi">
        <div class="label">Non-Zero Rows</div>
        <div id="nonzeroRows" class="value">–</div>
      </div>
    </div>

    <div class="spacer"></div>

    <h2>📋 Operation Log</h2>
    <div id="log" class="log" aria-live="polite"><div class="muted">Operations will appear here...</div></div>

    <details style="margin-top:14px">
      <summary>🤔 Practice Questions</summary>
      <ul style="margin:.6em 0 0 1.3em; line-height:1.7; font-size:13px">
        <li>If a 4×5 matrix has rank 3, how many zero rows in echelon form?</li>
        <li>Can a 3×4 matrix have rank 5? Why or why not?</li>
        <li>If rank(A) = 3 and A is 3×3, is A invertible?</li>
      </ul>
    </details>
  </aside>
</main>

<footer>
  <strong>Engineering Mathematics • Matrix Rank Lab</strong><br>
  Integer operations • Echelon form • Understanding rank through reduction
</footer>

<script>
/* ===========================
   Core State & Utilities
   =========================== */
let R=3, C=4;
let inputs = [];
let stepState = null;
let logEl, narrEl;

function validateInteger(input) {
  const val = input.value;
  if (val === '' || val === '-') return;
  const num = parseInt(val);
  if (isNaN(num)) {
    input.value = '0';
  } else {
    input.value = num.toString();
  }
}

/* ===========================
   HOW-TO menu behavior
   =========================== */
function openHowto(){
  document.getElementById('howBackdrop').classList.add('open');
  const p = document.getElementById('howPanel');
  p.classList.add('open');
  p.setAttribute('aria-hidden','false');
  document.getElementById('howBtn').setAttribute('aria-expanded','true');
  document.body.style.overflow = 'hidden';
}
function closeHowto(){
  document.getElementById('howBackdrop').classList.remove('open');
  const p = document.getElementById('howPanel');
  p.classList.remove('open');
  p.setAttribute('aria-hidden','true');
  document.getElementById('howBtn').setAttribute('aria-expanded','false');
  document.body.style.overflow = '';
}
function selectLang(tab){
  const isEN = tab === 'EN';
  document.getElementById('tabEN').setAttribute('aria-selected', isEN ? 'true' : 'false');
  document.getElementById('tabTE').setAttribute('aria-selected', isEN ? 'false' : 'true');
  document.getElementById('panelEN').hidden = !isEN;
  document.getElementById('panelTE').hidden = isEN;
}

/* ===========================
   Matrix Grid Management
   =========================== */
function createGrid(){
  const grid = document.getElementById('matrix');
  grid.style.setProperty('--cols', C);
  grid.innerHTML = '';
  inputs = [];
  
  for (let r=0; r<R; r++){
    const row = [];
    for (let c=0; c<C; c++){
      const cell = document.createElement('div');
      cell.className = 'cell';
      const inp = document.createElement('input');
      inp.type = 'number';
      inp.inputMode = 'numeric';
      inp.pattern = '[0-9-]*';
      inp.value = '0';
      inp.step = '1';
      inp.setAttribute('aria-label', `Row ${r+1}, Col ${c+1}`);
      
      inp.addEventListener('input', () => {
        validateInteger(inp);
        drawLabels();
      });
      inp.addEventListener('blur', () => {
        if (inp.value === '' || inp.value === '-') inp.value = '0';
      });
      
      // Prevent zoom on double-tap for iOS
      let lastTap = 0;
      inp.addEventListener('touchend', (e) => {
        const currentTime = new Date().getTime();
        const tapLength = currentTime - lastTap;
        if (tapLength < 300 && tapLength > 0) {
          e.preventDefault();
          inp.focus();
        }
        lastTap = currentTime;
      });
      
      cell.appendChild(inp);
      grid.appendChild(cell);
      row.push(inp);
    }
    inputs.push(row);
  }
  
  refreshSelectors();
  drawLabels();
  setNarr('Matrix created. Enter integer values or use presets.');
  clearLog();
  updateKPIs();
}

function getM(){
  const M = [];
  for (let r=0; r<R; r++){
    const row = [];
    for (let c=0; c<C; c++){
      row.push(parseInt(inputs[r][c].value || '0'));
    }
    M.push(row);
  }
  return M;
}

function setM(M){
  R = M.length;
  C = M[0].length;
  document.getElementById('rows').value = R;
  document.getElementById('cols').value = C;
  createGrid();
  for (let r=0; r<R; r++){
    for (let c=0; c<C; c++){
      inputs[r][c].value = M[r][c].toString();
    }
  }
  drawLabels();
  updateKPIs();
}

function clearM(){
  for (let r=0; r<R; r++){
    for (let c=0; c<C; c++){
      inputs[r][c].value = '0';
    }
  }
  drawLabels();
  updateKPIs();
}

function randomM(){
  for (let r=0; r<R; r++){
    for (let c=0; c<C; c++){
      inputs[r][c].value = (Math.floor(Math.random() * 9) - 4).toString();
    }
  }
  drawLabels();
  updateKPIs();
}

/* ===========================
   Row Operations
   =========================== */
function swapRows(M, i, j){
  if (i === j) return;
  const temp = M[i];
  M[i] = M[j];
  M[j] = temp;
  log(`<span class="log-step">Swap</span> R<sub>${i+1}</sub> ↔ R<sub>${j+1}</sub>`);
}

function addRow(M, dest, src, k){
  for (let c=0; c<C; c++){
    M[dest][c] = M[dest][c] + k * M[src][c];
  }
  const sign = k >= 0 ? '+' : '';
  log(`<span class="log-step">Add</span> R<sub>${dest+1}</sub> ← R<sub>${dest+1}</sub> ${sign} ${k}·R<sub>${src+1}</sub>`);
}

function writeBack(M){
  for (let r=0; r<R; r++){
    for (let c=0; c<C; c++){
      inputs[r][c].value = M[r][c].toString();
    }
  }
  drawLabels();
  updateKPIs();
}

/* ===========================
   Rank Calculation
   =========================== */
function calculateRank(M){
  let rank = 0;
  for (let r=0; r<R; r++){
    let hasNonZero = false;
    for (let c=0; c<C; c++){
      if (M[r][c] !== 0){
        hasNonZero = true;
        break;
      }
    }
    if (hasNonZero) rank++;
  }
  return rank;
}

function isEchelonForm(M){
  let lastPivotCol = -1;
  
  for (let r=0; r<R; r++){
    let pivotCol = -1;
    for (let c=0; c<C; c++){
      if (M[r][c] !== 0){
        pivotCol = c;
        break;
      }
    }
    
    if (pivotCol === -1){
      for (let r2=r+1; r2<R; r2++){
        for (let c=0; c<C; c++){
          if (M[r2][c] !== 0) return false;
        }
      }
      return true;
    }
    
    if (pivotCol <= lastPivotCol) return false;
    
    for (let r2=r+1; r2<R; r2++){
      if (M[r2][pivotCol] !== 0) return false;
    }
    
    lastPivotCol = pivotCol;
  }
  
  return true;
}

/* ===========================
   Step-by-Step Algorithm
   =========================== */
function nextStep(){
  let M = getM();
  
  if (!stepState){
    stepState = {col: 0, searchRow: 0};
    log('<strong>🚀 Starting reduction...</strong>');
    setNarr('Beginning reduction. Looking for first pivot...');
  }
  
  let {col, searchRow} = stepState;
  
  if (col >= C || searchRow >= R){
    setNarr('✅ <strong>Complete!</strong> Matrix is in echelon form.');
    log('<strong>✅ Done!</strong> Echelon form reached.');
    stepState = null;
    drawLabels();
    updateKPIs();
    return;
  }
  
  let pivotRow = -1;
  for (let r=searchRow; r<R; r++){
    if (M[r][col] !== 0){
      pivotRow = r;
      break;
    }
  }
  
  if (pivotRow === -1){
    stepState.col++;
    setNarr(`No pivot in column ${col+1}. Moving to next...`);
    drawLabels({focusCol: col+1});
    updateKPIs();
    return;
  }
  
  if (pivotRow !== searchRow){
    swapRows(M, searchRow, pivotRow);
    writeBack(M);
    setNarr(`Pivot found in R<sub>${pivotRow+1}</sub>. Swapped with R<sub>${searchRow+1}</sub>.`);
    drawLabels({focusRow: searchRow, focusCol: col});
    return;
  }
  
  for (let r=searchRow+1; r<R; r++){
    if (M[r][col] !== 0){
      const pivot = M[searchRow][col];
      const target = M[r][col];
      let k;
      if (target % pivot === 0){
        k = -target / pivot;
      } else {
        k = -Math.round(target / pivot);
      }
      
      addRow(M, r, searchRow, k);
      writeBack(M);
      setNarr(`Zeroing R<sub>${r+1}</sub>, C<sub>${col+1}</sub> by adding ${k}×R<sub>${searchRow+1}</sub>.`);
      drawLabels({focusRow: r, focusCol: col});
      return;
    }
  }
  
  stepState.col++;
  stepState.searchRow++;
  setNarr(`Column ${col+1} complete. Moving to next...`);
  drawLabels({focusCol: col+1});
  updateKPIs();
}

function finish(){
  let guard = 0;
  while (guard++ < 500 && stepState !== null){
    nextStep();
  }
}

/* ===========================
   Visual Labels
   =========================== */
function drawLabels(opts = {}){
  const {focusRow, focusCol} = opts;
  
  document.querySelectorAll('.pivotMark, .zeroMark').forEach(e => e.remove());
  
  const M = getM();
  const pivots = [];
  
  for (let r=0; r<R; r++){
    for (let c=0; c<C; c++){
      if (M[r][c] !== 0){
        pivots.push({r, c});
        break;
      }
    }
  }
  
  pivots.forEach(({r, c}) => {
    const cell = inputs[r][c].parentElement;
    const mark = document.createElement('div');
    mark.className = 'pivotMark';
    mark.textContent = 'pivot';
    cell.appendChild(mark);
    inputs[r][c].classList.add('pivot-cell');
  });
  
  pivots.forEach(({r, c}) => {
    for (let r2=r+1; r2<R; r2++){
      if (M[r2][c] !== 0){
        const mark = document.createElement('div');
        mark.className = 'zeroMark';
        mark.textContent = '→0';
        inputs[r2][c].parentElement.appendChild(mark);
      }
    }
  });
  
  for (let r=0; r<R; r++){
    let allZero = true;
    for (let c=0; c<C; c++){
      if (M[r][c] !== 0){
        allZero = false;
        break;
      }
    }
    for (let c=0; c<C; c++){
      if (allZero){
        inputs[r][c].classList.add('zero-row');
      } else {
        inputs[r][c].classList.remove('zero-row');
      }
    }
  }
  
  for (let r=0; r<R; r++){
    for (let c=0; c<C; c++){
      const inp = inputs[r][c];
      if (focusRow === r || focusCol === c){
        inp.style.boxShadow = '0 0 0 3px rgba(232,255,125,0.25)';
        inp.style.borderColor = '#a1ad3a';
      } else {
        inp.style.boxShadow = 'none';
        inp.style.borderColor = '#2b3356';
      }
      
      let isPivot = false;
      pivots.forEach(p => {
        if (p.r === r && p.c === c) isPivot = true;
      });
      if (!isPivot) inp.classList.remove('pivot-cell');
    }
  }
}

function updateKPIs(){
  const M = getM();
  const rank = calculateRank(M);
  document.getElementById('rank').textContent = rank;
  document.getElementById('nonzeroRows').textContent = rank;
}

function setNarr(html){
  narrEl.innerHTML = html;
}

function log(html){
  logEl.insertAdjacentHTML('beforeend', `<div>• ${html}</div>`);
  logEl.scrollTop = logEl.scrollHeight;
}

function clearLog(){
  logEl.innerHTML = '<div class="muted">Operations will appear here...</div>';
}

function refreshSelectors(){
  const rOpts = Array.from({length: R}, (_, i) => 
    `<option value="${i}">${i+1}</option>`
  ).join('');
  
  ['rSwapA', 'rSwapB', 'rAddDest', 'rAddDest2', 'rAddSrc'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.innerHTML = rOpts;
  });
}

function presetA(){
  setM([
    [2, 4, 6, 8],
    [1, 2, 1, 3],
    [3, 6, 7, 11]
  ]);
  setNarr('<strong>Preset A loaded.</strong> Rank 2 expected. Tap Next Step!');
  log('<strong>Preset A:</strong> 3×4 matrix (rank 2)');
  stepState = null;
}

function presetB(){
  setM([
    [1, 2, 3, 4],
    [2, 4, 6, 8],
    [1, 1, 1, 1],
    [0, 1, 2, 3]
  ]);
  setNarr('<strong>Preset B loaded.</strong> Rank 3 expected. Watch the algorithm!');
  log('<strong>Preset B:</strong> 4×4 matrix (rank 3)');
  stepState = null;
}

/* ===========================
   Event Listeners
   =========================== */
window.addEventListener('DOMContentLoaded', () => {
  logEl = document.getElementById('log');
  narrEl = document.getElementById('narr');
  
  // How-to menu
  document.getElementById('howBtn').addEventListener('click', () => {
    const panel = document.getElementById('howPanel');
    if (panel.classList.contains('open')) closeHowto();
    else openHowto();
  });
  document.getElementById('howClose').addEventListener('click', closeHowto);
  document.getElementById('howBackdrop').addEventListener('click', closeHowto);
  document.addEventListener('keydown', e => {
    if (e.key === 'Escape') closeHowto();
  });
  document.getElementById('tabEN').addEventListener('click', () => selectLang('EN'));
  document.getElementById('tabTE').addEventListener('click', () => selectLang('TE'));
  
  // Matrix controls
  document.getElementById('resize').addEventListener('click', () => {
    const r = Math.max(2, Math.min(6, parseInt(document.getElementById('rows').value || '3')));
    const c = Math.max(2, Math.min(6, parseInt(document.getElementById('cols').value || '4')));
    R = r;
    C = c;
    createGrid();
    stepState = null;
  });
  
  document.getElementById('random').addEventListener('click', () => {
    randomM();
    setNarr('Random matrix generated. Tap <strong>Next Step</strong>!');
    stepState = null;
  });
  
  document.getElementById('reset').addEventListener('click', () => {
    clearM();
    setNarr('Matrix cleared. Enter your values.');
    clearLog();
    stepState = null;
  });
  
  document.getElementById('presetA').addEventListener('click', presetA);
  document.getElementById('presetB').addEventListener('click', presetB);
  
  document.getElementById('next').addEventListener('click', nextStep);
  document.getElementById('finish').addEventListener('click', finish);
  
  document.getElementById('verify').addEventListener('click', () => {
    const M = getM();
    const inEchelon = isEchelonForm(M);
    const rank = calculateRank(M);
    
    if (inEchelon){
      setNarr(`✅ <strong>Correct!</strong> Echelon form, rank = ${rank}.`);
      log(`<strong>✅ Verified:</strong> Echelon form, rank = ${rank}`);
    } else {
      setNarr(`❌ Not quite. Continue—pivots should move right, zeros below.`);
      log(`<strong>❌ Not echelon yet.</strong> Current rank: ${rank}`);
    }
    drawLabels();
  });
  
  // Manual operations
  document.getElementById('rSwapBtn').addEventListener('click', () => {
    const a = parseInt(document.getElementById('rSwapA').value);
    const b = parseInt(document.getElementById('rSwapB').value);
    const M = getM();
    swapRows(M, a, b);
    writeBack(M);
    setNarr(`Swapped R<sub>${a+1}</sub> ↔ R<sub>${b+1}</sub>.`);
    stepState = null;
  });
  
  document.getElementById('rAddBtn').addEventListener('click', () => {
    const dest = parseInt(document.getElementById('rAddDest').value);
    const src = parseInt(document.getElementById('rAddSrc').value);
    const k = parseInt(document.getElementById('rAddK').value || '0');
    
    const M = getM();
    addRow(M, dest, src, k);
    writeBack(M);
    const sign = k >= 0 ? '+' : '';
    setNarr(`Added: R<sub>${dest+1}</sub> ← R<sub>${dest+1}</sub> ${sign} ${k}×R<sub>${src+1}</sub>.`);
    stepState = null;
  });
  
  createGrid();
});
</script>
</body>
</html>
